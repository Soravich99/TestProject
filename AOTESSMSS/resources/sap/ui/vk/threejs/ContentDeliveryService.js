/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","./thirdparty/three","sap/ui/vk/threejs/thirdparty/totara","./PerspectiveCamera","./OrthographicCamera","sap/ui/vk/View"],function(q,M,t,a,P,O,V){"use strict";var C=M.extend("sap.ui.vk.threejs.ContentDeliveryService",{metadata:{publicMethods:["initUrl","load","update","loadView"],events:{cameraChanged:{parameters:{sceneId:{type:"string"},camera:{type:"any"}},enableEventBubbling:true},sceneUpdated:{parameters:{sceneId:{type:"string"}},enableEventBubbling:true},errorReported:{paramters:{error:{type:"any"}}}}}});var b=C.getMetadata().getParent().getClass().prototype;C.prototype.init=function(){if(b.init){b.init.call(this);}this._loader=null;this._transientSceneMap=new Map();};C.prototype.initUrl=function(u,h){var d=this;var e;var f;if(!d._loader){this._loader=new Totara.Loader();}var p=[];if(q.sap.startsWith(u,"ws")){e=new Totara.Loader.WebSocketConnection();f=e.init(u).then(function(){d._loader.init(e);}).catch(function(g){d._loader=null;throw g;});p.push(f);}else if(q.sap.startsWith(u,"http")){e=new Totara.Loader.HttpConnection();f=e.init(u,h).then(function(){d._loader.init(e);});p.push(f);}else{d._loader=null;p.push(Promise.reject("Content Delivery Service only allows http and websocket connection"));}return Promise.all(p);};function c(d){if(!d){return null;}var e;if(d.isOrthographicCamera){e=new sap.ui.vk.threejs.OrthographicCamera();}else if(d.isPerspectiveCamera){e=new sap.ui.vk.threejs.PerspectiveCamera();}e.setCameraRef(d);e.setUsingDefaultClipPlanes(true);if(d.cameraInfo&&d.cameraInfo.zoom===-1){e.setZoomNeedRecalculate(true);}return e;}C.prototype._createLoadParam=function(r,d,s,p,e){var f=this;var i;var g=false;var h=false;if(s.logger===true){h=true;}var j={root:p,includeHidden:s.includeHidden,pushPMI:s.pushPMI,metadataFilter:s.metadataFilter,onActiveCamera:function(n){var k=false;var l=f._loader.getState();if(l){var m=l.contextMap.get(s.veid);if(m&&m.phase<2){i=c(n);k=true;}}if(!k){f.fireCameraChanged({sceneId:s.veid,camera:c(n)});}},onSetGeometry:function(){f.fireSceneUpdated({sceneId:s.veid});},onInitialSceneFinished:function(){g=true;r({node:p,camera:i,contentResource:e,loader:f});},activateView:s.activateView,logger:h,onError:function(k){var l;if(k.errorText){l=k.errorText;}else if(k.error){l=k.error;}else if(k.reason){l=k.reason;}else{l="failed to load: unknown reason";}if(!g){d(l);}else{f.fireErrorReported(k);}}};return j;};C.prototype.load=function(p,d){var e=this;return new Promise(function(r,f){var s={url:d.getSource(),veid:d.getVeid(),httpHeaders:d.getHttpHeaders(),includeHidden:d.getIncludeHidden(),pushPMI:d.getPushPMI(),metadataFilter:d.getMetadataFilter()};if(!s.url||!s.veid){f("url or veid not specified");return;}e.initUrl(s.url,s.httpHeaders).then(function(){var g=e._createLoadParam(r,f,s,p,d);e._loader.request(s.veid,g);}).catch(function(g){f(g);});});};C.prototype.getState=function(){if(this._loader){return this._loader.getState();}return null;};C.prototype.decrementResouceCountersForDeletedTreeNode=function(s){var d=this.getState();if(d){d.contextMap.forEach(function(v,k){if(v.treeNodeMap.has(s)){Totara.decrementResouceCountersForDeletedTreeNode(d,v,s);}});}};C.prototype.loadTransientScene=function(s,p){var d=this;return new Promise(function(r,e){if(!s||!p){e("invalid arguments");return;}if(d._transientSceneMap.has(s)){var f=d._transientSceneMap.get(s).clone();p.add(f);r({nodeRef:f});return;}if(!d._loader){e("ContentDeliveryService is not initialised");return;}var g=new THREE.Object3D();g.name="transient";var h={root:g,onSceneCompleted:function(){d._transientSceneMap.set(s,g);var f=g.clone();p.add(f);r({nodeRef:f});}};d._loader.request(s,h);});};C.prototype.update=function(s,d,v){if(!this._loader){return Promise.reject("ContentDeliveryService is not initialised");}else{return Promise.resolve(this._loader.update(s,d,v));}};C.prototype.exit=function(){if(b.exit){b.exit.call(this);}if(this._loader){this._loader.dispose();this._loader=null;}this._transientSceneMap=null;};C.prototype.loadView=function(s,v,d){if(typeof d==="undefined"){d="static";}return this._loader.requestView(s,d,v).then(function(e){var m=new sap.ui.vk.View({name:e.name,nodeInfos:e.viewNodes});if(e.camera){var f=true;var r=false;if(e.camera.cameraInfo&&e.camera.cameraInfo.zoom===-1){r=true;}if(e.camera.type==="PerspectiveCamera"){m.setCameraInfo({type:e.camera.type,fov:e.camera.cameraInfo.fov*180/Math.PI,position:e.camera.position.toArray(),nearClipPlane:e.camera.near,farClipPlane:e.camera.far,upDirection:e.camera.up.toArray(),targetDirection:e.camera.getWorldDirection().toArray(),usingDefaultClipPlanes:f});}if(e.camera.type==="OrthographicCamera"){m.setCameraInfo({type:e.camera.type,zoomFactor:e.camera.zoom,position:e.camera.position.toArray(),nearClipPlane:e.camera.near,farClipPlane:e.camera.far,upDirection:e.camera.up.toArray(),targetDirection:e.camera.getWorldDirection().toArray(),usingDefaultClipPlanes:f,zoomNeedRecalculate:r});}}return m;}).catch(function(e){q.sap.log.error(e);return null;});};C.prototype.printLogTokens=function(){if(this._loader){this._loader.printLogTokens();return true;}else{return false;}};return C;});
