/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","./Utilities","./thirdparty/three","./thirdparty/ColladaLoader"],function(q,B,U,T,C){"use strict";var t="sap.ui.vbm.adapter3d.SceneBuilder";var l=q.sap.log;var d=T.Math.degToRad;var a=T.Box3;var F=T.Face3;var M=T.Matrix4;var V=T.Vector2;var b=T.Vector3;var r="_sapRefCount";var c;var f;var n;var g=U.toBoolean;var h=U.toFloat;var i=U.toVector3;var j=U.toColor;var k=U.toDeltaColor;var m=U.applyColor;var o=U.applyColorBorder;var S=B.extend("sap.ui.vbm.adapter3d.SceneBuilder",{constructor:function(e,p,v){B.call(this);this._context=e;this._viewport=v;this._root=p;this._textureLoader=null;this._colladaLoader=null;this._textures=new Map();this._boxGeometryWith4SidedTexture=null;this._boxGeometryWith6SidedTexture=null;}});S.prototype.destroy=function(){this._context=null;this._root=null;B.prototype.destroy.call(this);};S.prototype.synchronize=function(){var e=this;return new Promise(function(p,s){var u=new Map();var v=function(H){if(u.has(H)){u.get(H).refCount+=1;}else{u.set(H,{object3D:null,refCount:1});}};var w=new Set();var x=sap.ui.vbm.findInArray(e._context.windows,function(x){return x.type==="default";});var y=x&&sap.ui.vbm.findInArray(e._context.scenes,function(y){return y.id===x.refScene;});if(!y){p();return;}if(e._context.setupView){var z=e._context.setupView;e._setupView(z.position,z.zoom,z.pitch,z.yaw,z.home,z.flyTo);e._context.setupView=undefined;}var A=e._context.voQueues.toAdd.get(y)||[];var D=e._context.voQueues.toUpdate.get(y)||[];var E=e._context.voQueues.toRemove.get(y)||[];var G=[].concat(A,D);G.filter(function(H){return H.isColladaModel&&H.model&&H.model!==H._lastModel;}).map(function(H){return H.model;}).forEach(v);G.filter(function(H){return H.texture&&H.texture!==H._lastTexture;}).map(function(H){return H.texture;}).forEach(w.add,w);e._loadTextures(w).then(function(){return e._loadModels(u);}).then(function(){E.forEach(e._destroyVisualObjectInstance.bind(e,e._root));D.forEach(e._updateVisualObjectInstance.bind(e,e._root,u));A.forEach(e._addVisualObjectInstance.bind(e,e._root,u));e._cleanupCache();p();}).catch(function(H){s(H);});});};S.prototype._getGeometrySize=function(){return 2.0;};S.prototype._setupView=function(p,z,e,y,s,u){var v=new b(0,0,-5);var w=new b(0,0,0);p=p||"0;0;0";var x=p.split(";");p=new b(parseFloat(x[0]),parseFloat(x[1]),parseFloat(x[2]));var A=new b(p.x,p.z,-p.y);this._root.position.copy(A);z=parseFloat(z||"1");if(z===0){z=1;}else if(z<0){z=0.1;}var D=this._getGeometrySize()*2/z;e=parseFloat(e||"0");y=parseFloat(y||"0");e=(e%180===0?e+1:e);var E=new M();E.makeRotationX(d(e+180));var G=new M();G.makeRotationZ(d(-(y+180)));var H=new M();H.multiplyMatrices(G,E);var I=new b();I.subVectors(w,v);I.normalize();I.multiplyScalar(D);I.applyMatrix4(H);var J={zoom:1.0,target:w.clone(),position:new b(-I.x,-I.z,I.y)};if(s){this._viewport._setCameraHome(J);this._viewport._applyCamera(J,u);}else{this._viewport._applyCamera(J,u);}};S.prototype._loadTextures=function(e){var p=[];e.forEach(function(s){if(!this._textures.has(s)){p.push(this._loadTexture(s));}},this);return Promise.all(p);};S.prototype._loadTexture=function(e){var p=this;return new Promise(function(s,u){p._getTextureLoader().load(p._context.resources.get(e),function(v){v.flipY=false;v[r]=0;p._textures.set(e,v);s();},null,function(x){l.error("Failed to load texture from Data URI: "+e,"status: "+x.status+", status text: "+x.statusText,t);s();});});};S.prototype._loadModels=function(e){var p=[];e.forEach(function(s,u){p.push(this._loadModel(u,s));},this);return Promise.all(p);};S.prototype._loadModel=function(p,s){var u=this;return new Promise(function(v,w){try{u._getColladaLoader().parse(u._context.resources.get(p),function(x){f(x.scene);s.object3D=x.scene;x.scene.scale.set(1,1,-1);v();});}catch(e){l.error("Failed to load Collada model from resource: "+p,e instanceof Error?e.message:"",t);v();}});};S.prototype._releaseTexture=function(e){if(e.hasOwnProperty(r)){e[r]-=1;}else{e.dispose();}return this;};S.prototype._addRefTexture=function(e){if(!e.hasOwnProperty(r)){e[r]=0;}e[r]+=1;return this;};S.prototype._releaseGeometry=function(e){if(e.hasOwnProperty(r)){e[r]-=1;}else{e.dispose();}return this;};S.prototype._addRefGeometry=function(e){if(!e.hasOwnProperty(r)){e[r]=0;}e[r]+=1;return this;};S.prototype._cleanupCache=function(){this._textures.forEach(function(e){if(e[r]===0){e.dispose();this._textures.delete(e);}},this);if(this._boxGeometryWith4SidedTexture&&this._boxGeometryWith4SidedTexture[r]===0){this._boxGeometryWith4SidedTexture.dispose();this._boxGeometryWith4SidedTexture=null;}if(this._boxGeometryWith6SidedTexture&&this._boxGeometryWith6SidedTexture[r]===0){this._boxGeometryWith6SidedTexture.dispose();this._boxGeometryWith6SidedTexture=null;}return this;};S.prototype._destroyVisualObjectInstance=function(e,p){var s=this;if(p.object3D){p.object3D.traverse(function(u){if(u.isMesh){var v=u.material;if(v){var w=v.map;if(w){s._releaseTexture(w);v.map=null;}v.dispose();u.material=null;}var x=u.geometry;if(x){s._releaseGeometry(x);u.geometry=null;}}});e.remove(p.object3D);p.object3D=null;p._lastModel=null;p._lastTexture=null;p._lastTexture6=null;}return this;};S.prototype._updateVisualObjectInstance=function(e,p,s){if(s.isColladaModel){if(s.model!==s._lastModel){return this._destroyVisualObjectInstance(e,s)._addVisualObjectInstance(e,p,s);}this._assignColladaModelProperties(s);}else if(s.isBox){this._assignBoxProperties(s);}return this;};S.prototype._addVisualObjectInstance=function(e,p,s){if(s.isColladaModel){s._lastModel=s.model;var u=p.get(s.model);var v=--u.refCount===0?u.object3D:u.object3D.clone();s.object3D=new T.Group();s.object3D.add(v);if(g(s.normalize)){n(v);}this._assignMaterial(s.object3D,this._createMaterial());this._assignColladaModelProperties(s);}else if(s.isBox){s.object3D=new T.Group();s.object3D.add(new T.Mesh(undefined,this._createMaterial()));this._assignBoxProperties(s);}if(s.object3D){e.add(s.object3D);}return this;};S.prototype._assignColladaModelProperties=function(e){this._assignProperties(e);return this;};S.prototype._assignBoxProperties=function(e){if(e._lastTexture6!==e.texture6){var p=e.object3D.children[0];if(p.geometry){this._releaseGeometry(p.geometry);}p.geometry=this._getBoxGeometry(g(e.texture6));this._addRefGeometry(p.geometry);if(g(e.normalize)){n(p);}e._lastTexture6=e.texture6;}if(e._lastColorBorder&&e._lastColorBorder!==e.colorBorder){this._removeColorBorder(e);}if(e.colorBorder&&e._lastColorBorder!==e.colorBorder){this._assignColorBorder(e);}e._lastColorBorder=e.colorBorder;this._assignProperties(e);return this;};S.prototype._assignProperties=function(e){if(e._lastTexture&&e._lastTexture!==e.texture){this._removeTexture(e);}if(e.texture){this._assignTexture(e);}e._lastTexture=e.texture;m(e,e[g(e["VB:s"])?"selectColor":"color"]);var s=i(e.scale);e.object3D.scale.set(s[0],s[1],s[2]);var p=i(e.rot);e.object3D.rotation.set(d(p[0]),d(p[1]),d(p[2]),"YXZ");var u;if(e.isBox){u=new b(0,0,-1);}else{var v=e.object3D.children[0].vbBox;u=new b(0,0,-1.0*(v.min.z>0?v.min.z:v.max.z));}var w=new M();w.makeRotationFromEuler(new T.Euler(d(p[0]),d(p[1]),d(p[2]),"YXZ"));var x=new M();x.makeScale(s[0],s[1],s[2]);x.multiply(w);u.applyMatrix4(x);u.z=-u.z;var y=i(e.pos);var z=new b(y[0],y[1],y[2]);z.sub(u);e.object3D.position.set(z.x,z.y,z.z);e.object3D.traverse(function(A){A._sapInstance=e;});return this;};S.prototype._removeTexture=function(e){if(e.object3D){var p=this;e.object3D.traverse(function(s){if(s.isMesh&&s.material&&s.material.map){p._releaseTexture(s.material.texture);s.material.map=null;}});}return this;};S.prototype._assignTexture=function(e){if(e.object3D){var p=this;var s=this._textures.get(e.texture);e.object3D.traverse(function(u){if(u.isMesh&&u.material){u.material.map=s;p._addRefTexture(s);}});}return this;};S.prototype._removeColorBorder=function(e){if(e.object3D){e.object3D.traverse(function(p){var w=sap.ui.vbm.findIndexInArray(p.children,function(u){return u.isLineSegments;});if(w!==-1){var s=p.children[w];p.remove(s);s.geometry.dispose();s.material.dispose();s=undefined;}});}return this;};S.prototype._assignColorBorder=function(e){var p=e.object3D.children[0];p.add(new T.LineSegments(new T.EdgesGeometry(p.geometry),this._createLineBasicMaterial()));o(e,e.colorBorder);return this;};S.prototype._createMaterial=function(){return new T.MeshPhongMaterial({shininess:1,specular:0x101009,side:T.FrontSide});};S.prototype._createLineBasicMaterial=function(){return new T.LineBasicMaterial({linewidth:3});};S.prototype._assignMaterial=function(e,p){e.traverse(function(s){if(s.isMesh){s.material=p;}});return this;};S.prototype._getBoxGeometry=function(e){var p=e?"_boxGeometryWith6SidedTexture":"_boxGeometryWith4SidedTexture";return this[p]||(this[p]=c(e));};S.prototype._getTextureLoader=function(){return this._textureLoader||(this._textureLoader=new T.TextureLoader());};S.prototype._getColladaLoader=function(){return this._colladaLoader||(this._colladaLoader=new C());};f=function(e){var p=[];e.traverse(function(s){if(s.isLight||s.isCamera){p.push(s);}});p.forEach(function(s){while(s&&s!==e){var u=s.parent;if(s.children.length===0){u.remove(s);}s=u;}});return e;};n=function(e){var p=new a().setFromObject(e);var s=p.getCenter();p.min.sub(new b(s.x,s.y,-s.z));p.max.sub(new b(s.x,s.y,-s.z));var u=Math.max(Math.abs(p.min.x),Math.abs(p.min.y),Math.abs(p.min.z),Math.abs(p.max.x),Math.abs(p.max.y),Math.abs(p.max.z));if(u){u=1/u;}p.min.set(p.min.x*u,p.min.y*u,-p.min.z*u);p.max.set(p.max.x*u,p.max.y*u,-p.max.z*u);U.swap(p,"min","max");e.vbBox=p;var v=new M().makeScale(u,u,u);var w=new M().makeTranslation(-s.x,-s.y,-s.z);e.updateMatrix();v.multiply(w);v.multiply(e.matrix);v.decompose(e.position,e.quaternion,e.scale);return e;};c=function(e){var p=new T.Geometry();var s=0.1;p.vertices.push(new b(s,s,-s),new b(s,-s,-s),new b(-s,-s,-s),new b(-s,s,-s),new b(s,s,s),new b(-s,s,s),new b(-s,-s,s),new b(s,-s,s),new b(s,s,-s),new b(s,s,s),new b(s,-s,s),new b(s,-s,-s),new b(s,-s,-s),new b(s,-s,s),new b(-s,-s,s),new b(-s,-s,-s),new b(-s,-s,-s),new b(-s,-s,s),new b(-s,s,s),new b(-s,s,-s),new b(s,s,s),new b(s,s,-s),new b(-s,s,-s),new b(-s,s,s));var u=new T.Color(0.5,0.5,0.5);p.faces.push(new F(0,2,3,new b(0,0,-1),u),new F(0,1,2,new b(0,0,-1),u),new F(4,5,6,new b(0,0,1),u),new F(4,6,7,new b(0,0,1),u),new F(8,10,11,new b(1,0,0),u),new F(8,9,10,new b(1,0,0),u),new F(12,14,15,new b(0,-1,0),u),new F(12,13,14,new b(0,-1,0),u),new F(16,18,19,new b(-1,0,0),u),new F(16,17,18,new b(-1,0,0),u),new F(20,22,23,new b(0,1,0),u),new F(20,21,22,new b(0,1,0),u));var v;if(e){v=[new V(2/3,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(2/3,1.0),new V(2/3,0.5),new V(2/3,0.0),new V(1.0,0.0),new V(1.0,0.5),new V(2/3,0.5),new V(2/3,1.0),new V(1/3,1.0),new V(1/3,0.5),new V(2/3,0.0),new V(2/3,0.5),new V(1/3,0.5),new V(1/3,0.0),new V(1/3,0.5),new V(1/3,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.0,0.5),new V(0.0,0.0),new V(1/3,0.0),new V(1/3,0.5)];}else{v=[new V(0.5,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(0.5,1.0),new V(0.5,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(0.5,1.0),new V(0.5,0.5),new V(0.5,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.5,0.5),new V(0.5,0.0),new V(1.0,0.0),new V(1.0,0.5),new V(0.5,0.5),new V(0.5,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.0,0.5),new V(0.0,0.0),new V(0.5,0.0),new V(0.5,0.5)];}p.faceVertexUvs[0].push([v[0],v[2],v[3]],[v[0],v[1],v[2]],[v[5],v[6],v[7]],[v[5],v[7],v[4]],[v[8],v[10],v[11]],[v[8],v[9],v[10]],[v[12],v[14],v[15]],[v[12],v[13],v[14]],[v[16],v[18],v[19]],[v[16],v[17],v[18]],[v[20],v[22],v[23]],[v[20],v[21],v[22]]);return p;};return S;});
