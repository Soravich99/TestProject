sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState"],function(q,B,N,S,U){"use strict";var d="sap.suite.ui.generic.template.customData",a="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function g(s,c,o){var b=c.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var e=false;var h=null;var A=Promise.resolve();var D=false;var j=false;var E=c.byId("editStateFilter");var k;var l=null;var m=null;s.oSmartFilterbar.setSuppressSelection(true);var p=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function t(){return D;}function u(){var T={};T[d]={};var V=[];var W=p();for(var i=0;i<W.length;i++){var X=W[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(X)){V.push(X);}}T[a]={suppressDataSelection:!D,visibleCustomFields:V};if(E){T[a].editStateFilter=E.getSelectedKey();}var Y=s.oMultipleViewsHandler.getContentForIappState();if(Y){var Z=Y.mode==="single"?"tableViewData":"tableTabData";T[a][Z]=Y.state;}c.getCustomAppStateDataExtension(T[d]);return T;}function v(){var T=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());var V=new S(T);var W=c.getVisibleSelectionsWithDefaults();for(var i=0;i<W.length;i++){if(!V.getValue(W[i])){V.addSelectOption(W[i],"I","EQ","");}}if(c.byId('template::PageVariant')&&c.byId('template::PageVariant').currentVariantGetModified()&&V.getID()){V.setID("");}var X={selectionVariant:V.toJSONString(),tableVariantId:(!b&&s.oSmartTable.getCurrentVariantId())||"",customData:u()};return X;}function w(){if(!j){return;}j=false;try{l=o.storeInnerAppStateWithImmediateReturn(v(),true);}catch(i){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(l instanceof N){j=true;l=null;return;}l.promise.fail(function(T){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+T);});if(m===l.appStateKey){l=null;}else{o.replaceHash(l.appStateKey);}}function R(T,V){if(T&&T.editStateFilter!==undefined){if(E){E.setSelectedKey((T.editStateFilter===null)?0:T.editStateFilter);}}var W=T&&T.visibleCustomFields;if(W&&W.length>0){var X=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<X.length;i++){var Y=X[i];var Z=Y.getName();if(W.indexOf(Z)!==-1){Y.setVisibleInFilterBar(true);}}}D=V&&!(T&&T.suppressDataSelection);if(D){s.oSmartFilterbar.search();Q(D);}}function x(i){c.restoreCustomAppStateDataExtension(i||{});}function y(i,T){i=i||{};if(i.hasOwnProperty(d)&&i.hasOwnProperty(a)){x(i[d]);R(i[a],T);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}x(i);}}function z(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":[r.appStateKey]};}return r.urlParams;});}function C(i,T){if(e){return;}if(i||T!==D){D=T;if(!j){j=true;if(!s.oSmartFilterbar.isDialogOpen()){if(h){w();}else{setTimeout(w,0);}}}}}function F(T,V,W){s.oSmartFilterbar.setSuppressSelection(false);var X=T.appStateKey||"";if(e){return;}if(m===null){m=X;}else if(X!==m){return;}e=true;var Y=T.selectionVariant||"";var Z=(!b&&T.tableVariantId)||"";var $=(!X&&V)||{};if(!s.bWorkListEnabled){if((r.appStateKey!==X||r.selectionVariant!==Y||r.tableVariantId!==Z||f(r.urlParams,$))&&W!==sap.ui.generic.app.navigation.service.NavType.initial){if(!l||l.appStateKey!==X){var _=T&&T.bNavSelVarHasDefaultsOnly;if(T.oSelectionVariant&&r.selectionVariant!==Y){var a1=T.oSelectionVariant.getParameterNames().concat(T.oSelectionVariant.getSelectOptionsPropertyNames());for(var i=0;i<a1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(a1[i]);}}var b1=new U({selectionVariant:T.oSelectionVariant.toJSONObject()});T.oUiState=b1;if(_&&s.oSmartFilterbar.isCurrentVariantStandard()){s.oSmartFilterbar.setUiState(b1,{bReplace:false,bStrictMode:false});}else if(!_||s.oSmartFilterbar.isCurrentVariantStandard()){s.oSmartFilterbar.clearVariantSelection();s.oSmartFilterbar.clear();s.oSmartFilterbar.setUiState(b1,{bReplace:true,bStrictMode:false});}if(Z!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(Z);}T.customData=T.customData||{};var c1=s.oMultipleViewsHandler.getMode();if(c1){var d1=c1==="single"?"tableViewData":"tableTabData";if(T.customData[a]&&T.customData[a][d1]){s.oMultipleViewsHandler.restoreFromIappState(T.customData[a][d1]);}}y(T.customData,true);}r={appStateKey:X,urlParams:$,selectionVariant:Y,tableVariantId:Z};}}if(h){h();h=null;}if(W!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var e1=(W===sap.ui.generic.app.navigation.service.NavType.xAppState||W===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!T.bNavSelVarHasDefaultsOnly;D=e1||s.bLoadListAndFirstEntryOnStartup||k||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()||s.oMultipleViewsHandler.getEnableAutoBinding();if(D){s.oSmartFilterbar.search();Q(D);}}l=null;e=false;}function P(){if(!h){A=new Promise(function(T){h=T;});}var i=new Promise(function(T,V){var W=o.parseNavigation();W.done(function(X,Y,Z){F(X,Y,Z);T();});W.fail(function(X,Y,Z){q.sap.log.warning(X.getErrorCode(),"app state could not be parsed - continuing with empty state","sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");F({},Y,sap.ui.generic.app.navigation.service.NavType.initial);T();});});return i;}function G(){var i=v();s.oSmartFilterbar.setFilterData({_CUSTOM:i.customData});}function H(){C(true,D);}function J(i){var T=i.getParameter("context");var V=s.oSmartFilterbar.getFilterData();if(V._CUSTOM!==undefined){y(V._CUSTOM);}else{var W=u();n(W[d]);n(W[a]);y(W);}if(I.indexOf(T)<0){D=i.getParameter("executeOnSelect");C(true,D);}}function K(){if(!b){C(true,D);}}function L(){if(!b){C(true,D);}}function M(i){var T=i.getParameter("arguments");var V=T&&T["?query"];m=(V&&V["sap-iapp-state"])||"";if(l){if(l.appStateKey!==m){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+m+" expected "+l.appStateKey);return false;}P();return true;}return false;}function O(){k=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(w);}function Q(D){if(c&&c.getOwnerComponent&&c.getOwnerComponent().getModel){var T=c.getOwnerComponent().getModel("_templPriv");if(D){T.setProperty("/listReport/isHeaderExpanded",false);}else{T.setProperty("/listReport/isHeaderExpanded",true);}}}s.getCurrentAppState=v;return{areDataShownInTable:t,parseUrlAndApplyAppState:P,getUrlParameterInfo:z,changeIappState:C,onSmartFilterBarInitialise:O,onBeforeSFBVariantFetch:G,onAfterSFBVariantSave:H,onAfterSFBVariantLoad:J,onAfterTableVariantSave:K,onAfterApplyTableVariant:L,isStateChange:M};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,c,o){q.extend(this,g(s,c,o));}});});
