sap.ui.define(["sap/m/HeaderContainer","sap/suite/ui/generic/template/AnalyticalListPage/controller/VisualFilterDialogController","sap/m/Label","sap/ui/comp/odata/ODataModelUtil","sap/ui/comp/smartfilterbar/FilterProvider","sap/suite/ui/generic/template/AnalyticalListPage/control/visualfilterbar/VisualFilterProvider","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/comp/smartvariants/SmartVariantManagement","sap/ui/model/Filter","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/ui/comp/odata/MetadataAnalyser","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/m/VBox","sap/m/Button","sap/suite/ui/generic/template/AnalyticalListPage/controller/DropDownController"],function(H,V,L,O,F,a,P,S,b,c,T,M,d,f,g,B,D){"use strict";var o=sap.ui.model.SimpleType.extend("sap.ui.model.DimensionFilterType",{formatValue:function(v){return v;},parseValue:function(v){return v;},validateValue:function(v){}});var h=H.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.SmartVisualFilterBar",{metadata:{designTime:true,properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},config:{type:"object",group:"Misc",defaultValue:null},persistencyKey:{type:"string",group:"Misc",defaultValue:null},displayCurrency:{type:"string",group:"Misc",defaultValue:null},smartFilterId:{type:"string",group:"Misc",defaultValue:null}},associations:{smartVariant:{type:"sap.ui.core.Control",multiple:false}},events:{filterChange:{}}},renderer:{}});h.prototype.init=function(){if(H.prototype.init){H.prototype.init.apply(this,arguments);}var i=jQuery(document.body).hasClass("sapUiSizeCozy");this._cellItemHeightNorth="2.0rem";this._cellItemHeightSouth=i?"9.9rem":"7.9rem";this._cellHeight=i?"12rem":"10.9rem";this._cellWidth="20rem";this.labelHeight=2.0;this.compHeight=i?9.9:7.9;this.cellHeightPadding=1;this.cellHeight=(this.labelHeight+this.compHeight+this.cellHeightPadding)+"rem";this.cellWidth=320;this._dialogFilters={};this._compactFilters={};this._oVariantConfig={};this._smartFilterContext;this._oMetadataAnalyser;this.setModel(new sap.ui.model.json.JSONModel(),'_visualFilterConfigModel');if(i){if(sap.ui.Device.system.phone){this.setOrientation("Vertical");this.addStyleClass("sapSmartTemplatesAnalyticalListPageVisualFilterBarCozyPhone");}else{this.addStyleClass("sapSmartTemplatesAnalyticalListPageVisualFilterBarCozy");}}else{this.addStyleClass("sapSmartTemplatesAnalyticalListPageVisualFilterBar");}};h.prototype.propagateProperties=function(){H.prototype.propagateProperties.apply(this,arguments);this._initMetadata();};h.prototype._initMetadata=function(){if(!this.bIsInitialised){O.handleModelInit(this,this._onMetadataInit);}};h.prototype._onMetadataInit=function(){if(this.bIsInitialised){return;}this._annoProvider=this._createVisualFilterProvider();if(!this._annoProvider){return;}this._oMetadataAnalyser=this._annoProvider.getMetadataAnalyser();this.bIsInitialised=true;this._updateFilterBar();};h.prototype._createVisualFilterProvider=function(){var m=this.getModel();var e=this.getEntitySet();if(!m||!e){return null;}return new a(this);};h.prototype._getBasicGroupTitle=function(){return this.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE");};h.prototype._getFieldGroupForProperty=function(e,C){return this._annoProvider?this._annoProvider._getFieldGroupForProperty(e,C):undefined;};h.prototype._getGroupList=function(){return this._annoProvider?this._annoProvider.getGroupList():[];};h.prototype._getGroupMap=function(){return this._annoProvider?this._annoProvider.getGroupMap():{};};h.prototype._getMeasureMap=function(){return this._annoProvider?this._annoProvider.getMeasureMap():{};};h.prototype._getDimensionMap=function(){return this._annoProvider?this._annoProvider.getDimensionMap():{};};h.prototype.setSmartFilterContext=function(C){this._smartFilterContext=C;};h.prototype._updateFilterBar=function(){var e=this._getAnnotationSettings();if(e&&e.filterList){var i=this._convertSettingsToConfig(e);}else{i={filterCompList:[]};this.getModel('_visualFilterConfigModel').setData(i);return;}var v=this._getVariantConfig();if(v&&v.config){i.filterCompList.forEach(function(j){if(v.config[j.component.properties.parentProperty]){jQuery.extend(true,j,v.config[j.component.properties.parentProperty]);}});this._oVariantConfig=i;}this.unbindAggregation('content',true);this.getModel('_visualFilterConfigModel').setData(i);this.bindAggregation('content',{path:"_visualFilterConfigModel>/filterCompList",factory:function(I,C){var j=C.getProperty('component'),p=j?j.properties:undefined,s=this._resolveChartType(j?j.type:undefined);return this._createHeaderItems(C.sPath,s,p);}.bind(this),filters:new sap.ui.model.Filter("shownInFilterBar",sap.ui.model.FilterOperator.EQ,true)});return;};h.prototype._createHeaderItems=function(p,t,i){var j=this._createFilterItemOfType(t,i),I=j.getInParameters(),k=[],m=this;if(I&&I.length>0){I.forEach(function(e){k.push({path:'_filter>/'+e.localDataProperty});});}j.addCustomData(new sap.ui.core.CustomData({key:'sPath',value:p}));if(m.getEntitySet()===j.getEntitySet()){var l=m._smartFilterContext.determineMandatoryFilterItems();if(l&&l.length>0){l.forEach(function(e){if(!e.data("isCustomField")){k.push({path:'_filter>/'+e.getName()});}});}}j.bindProperty('dimensionFilter',{path:'_filter>/'+j.getParentProperty(),type:new o()});j.bindProperty('measureField',{path:'_visualFilterConfigModel>'+p+'/component/properties/measureField'});j.bindProperty('sortOrder',{path:'_visualFilterConfigModel>'+p+'/component/properties/sortOrder'});j.bindProperty('unitField',{path:'_visualFilterConfigModel>'+p+'/component/properties/measureField',formatter:function(){var e=m._getMeasureMap();var u=e[this.getEntitySet()][this.getMeasureField()];return u?u.fieldInfo.unit:"";}});if(k&&k.length>0){j.bindProperty('dimensionFilterExternal',{parts:k,formatter:function(){var I=this.getInParameters(),u=this.getParentProperty();var v,w;if(m.getEntitySet()===this.getEntitySet()){var l=m._smartFilterContext.determineMandatoryFilterItems();l.forEach(function(Y){var Z=Y.getName();var $=I&&I.some(function(e){return e.localDataProperty===Z;});if(Z.indexOf("$Parameter")===-1&&!$){I.push({localDataProperty:Z,valueListProperty:Z});}});}if(!(m.getEntitySet()===this.getEntitySet()&&m._smartFilterContext.getAnalyticBindingPath()!=="")&&(m._smartFilterContext.getAnalyticBindingPath()===""||m._smartFilterContext.getAnalyticBindingPath().indexOf("P_DisplayCurrency")!=-1)){var x=this.getMeasureField();var y=m.getModel();var z=y.getMetaModel();var E=z.getODataEntityType(m._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(this.getEntitySet()));var A=z.getODataEntitySet(this.getEntitySet());var G=z.getODataProperty(E,x);var J=m.getProperty("displayCurrency");var K=G&&G[f.ISOCurrency];if(J&&K){var N=K.Path;for(var Q=(I.length-1);Q>-1;Q--){var R=I[Q].valueListProperty;var U=I[Q].localDataProperty;if(R===N){var W=m._smartFilterContext.getFilterData();if(!W[U]){w=z.getODataProperty(E,N);var X=w&&d.isPropertyNonFilterable(A,w.name);if(!X){v=new b({aFilters:[new b({path:N,operator:"EQ",value1:J,value2:undefined})],and:false});}}break;}}}}return m._getFiltersForFilterItem(I,u,v,N);}});}if(j.attachFilterChange){j.attachFilterChange(this._onFilterChange,this);}if(j.attachTitleChange){j.attachTitleChange(this._onTitleChange,this);}var n=this._createTitleToolbar(i,j),q=new g({height:this._cellItemHeightNorth,items:[n]});var r=new g({width:"100%",height:this._cellItemHeightSouth,items:[new sap.m.Text({width:this.cellWidth+"px",textAlign:sap.ui.core.TextAlign.Center,text:{path:'_visualFilterConfigModel>'+p+'/overlayMessage',formatter:function(e){return this.getModel("i18n").getResourceBundle().getText(e);}}})],visible:{path:'_visualFilterConfigModel>'+p+'/showChartOverlay',formatter:function(v){return v;}}});r.addStyleClass("sapUiOverlay");r.addStyleClass("sapSmartTemplatesAnalyticalListPageVFOverflow");r.addStyleClass("sapSmartTemplatesAnalyticalListPageVFOverflowCozy");var s=new g({height:this._cellItemHeightSouth,items:[j],visible:{path:"_visualFilterConfigModel>"+p+"/showChartOverlay",formatter:function(v){return!v;}}});var C=new g({fieldGroupIds:["headerBar"],height:this._cellHeight,width:this.cellWidth+"px",items:[q,r,s]});return C;};h.prototype._getAnnotationSettings=function(){return this._annoProvider?this._annoProvider.getVisualFilterConfig():null;};h.prototype._convertSettingsToConfig=function(s,I){var e={filterCompList:[]};var k=this._getGroupList();var l={};for(var i=0;i<k.length;i++){var m=k[i];for(var j=0;j<m.fieldList.length;j++){var n=m.fieldList[j];l[n.name]={name:m.name,label:m.label};}}var p=this._getGroupMap();var q=p["_BASIC"];var r=[];if(q&&q.fieldList){for(var i=0;i<q.fieldList.length;i++){r.push(q.fieldList[i].name);}}var t=this._getMeasureMap(),u=s.filterList,v={};for(var i=0;i<u.length;i++){var w=u[i];var x=w.dimension.field;var y=t[w.collectionPath][w.measure.field];var z=false;if(y.fieldInfo[f.ISOCurrency]){z=true;}var C={shownInFilterBar:w.selected,component:{type:w.type,properties:{sortOrder:w.sortOrder,measureField:w.measure.field,parentProperty:w.parentProperty?w.parentProperty:undefined}}};if(!I){var A={shownInFilterDialog:w.selected||r.indexOf(x)!=-1,group:l[w.parentProperty],component:{properties:{scaleFactor:w.scaleFactor,numberOfFractionalDigits:w.numberOfFractionalDigits,filterRestriction:w.filterRestriction,width:this.cellWidth+"px",height:this.compHeight+"rem",entitySet:w.collectionPath?w.collectionPath:this.getEntitySet(),dimensionField:x,dimensionFieldDisplay:w.dimension.fieldDisplay,dimensionFilter:w.dimensionFilter,unitField:y?y.fieldInfo.unit:"",isCurrency:z,isDropDown:w.isDropDown,isMandatory:w.isMandatory,outParameter:w.outParameter?w.outParameter:undefined,inParameters:w.inParameters?w.inParameters:undefined,textArrangement:w.displayBehaviour,chartQualifier:w.chartQualifier?w.chartQualifier:undefined,dimensionFieldIsDateTime:w.dimensionFieldIsDateTime}}};jQuery.extend(true,C,A);e.filterCompList.push(C);}else{v[w.parentProperty]=C;}}return I?v:e;};h.prototype._setVariantModified=function(){if(this._oVariantManagement){this._oVariantManagement.currentVariantSetModified(true);}};h.prototype._onFilterChange=function(e){this._setVariantModified();this.fireFilterChange();};h.prototype._getFiltersForFilterItem=function(i,p,e,j){var k={},m=[],l=new sap.ui.model.Filter({aFilters:[],and:true});if(i){var r=function(s){s.sPath=v;};for(var n=(i.length-1);n>-1;n--){var q=i[n].localDataProperty,v=i[n].valueListProperty;if(q!==p&&m.indexOf(q)===-1){k=this._smartFilterContext.getFilters([q]);if(k&&k.length>0){if(k[0].aFilters){k[0].aFilters.forEach(r.bind(this));}else{r(k[0]);}m.push(q);l.aFilters.push(k[0]);}}}if(e){l.aFilters.push(e);}}return l;};h.prototype._createTitleToolbar=function(p,e){var t=new L({text:{path:"i18n>VIS_FILTER_TITLE_MD",formatter:function(){return e.getTitle();}}});if(e.getProperty("isMandatory")){t.addStyleClass("sapMLabelRequired");}var i=this._smartFilterContext.getControlByKey(p.parentProperty);this._smartFilterContext.ensureLoadedValueHelp(p.parentProperty);if(i){var j=d.getPropertyNameDisplay(this.getModel(),e.getEntitySet(),e.getDimensionField()),r=this.getModel("i18n").getResourceBundle(),I=i.getShowValueHelp&&i.getShowValueHelp(),s=(p.isDropDown)?"sap-icon://slim-arrow-down":"",k=I?"sap-icon://value-help":s,l,m=new B({text:{path:"_filter>/"+e.getParentProperty(),formatter:function(C){var q=e.getFilterRestriction();l=0;if(C){if(q==='single'){l=1;}else{if(typeof C==="object"){if(C.value){l++;}if(C.items&&C.items.length){l+=C.items.length;}if(C.ranges&&C.ranges.length){l+=C.ranges.length;}}else{l++;}}}return l?"("+l+")":"";}},icon:(I||p.isDropDown)?k:"",visible:{path:"_filter>/"+e.getParentProperty(),formatter:function(C){if(I||p.isDropDown){return true;}else{if(!C){return false;}if(typeof C==="object"){return(C.value||(C.items&&C.items.length)||(C.ranges&&C.ranges.length))?true:false;}return true;}}},press:function(E){if(I){i.fireValueHelpRequest.call(i);}else if(p.isDropDown){D.createDropdown(E.getSource(),e,this.getModel(),j,p);}else{V.launchAllFiltersPopup(m,e,E.getSource().getModel('i18n'));}},layoutData:new sap.m.OverflowToolbarLayoutData({priority:sap.m.OverflowToolbarPriority.NeverOverflow}),tooltip:{path:"_filter>/"+e.getParentProperty(),formatter:function(){return d.getTooltipForValueHelp(I,j,r,l);}}});}var n=new c({design:sap.m.ToolbarDesign.Transparent,width:this.cellWidth+"px",content:[t,new T(),m]});n.addStyleClass("sapSmartTemplatesAnalyticalListPageVisualFilterTitleToolbar");return n;};h.prototype.getTitleByFilterItemConfig=function(e,u,s){var p=e.component.properties;var i=p.entitySet;var m=this.getModel();if(!m){return"";}var j=d.getPropertyNameDisplay(m,i,p.measureField);var k=d.getPropertyNameDisplay(m,i,p.dimensionField);if(!u){u="";}if(!s){s="";}var t="";var r=this.getModel("i18n").getResourceBundle();if(s&&u){t=r.getText("VIS_FILTER_TITLE_MD_UNIT_CURR",[j,k,s,u]);}else if(u){t=r.getText("VIS_FILTER_TITLE_MD_UNIT",[j,k,u]);}else if(s){t=r.getText("VIS_FILTER_TITLE_MD_UNIT",[j,k,s]);}else{t=r.getText("VIS_FILTER_TITLE_MD",[j,k]);}return t;};h.prototype._onTitleChange=function(e){var C=e.getSource().getParent().getParent();var l=C.getItems()[0].getItems()[0].getContent()[0];if(e.getSource().getProperty("isMandatory")){l.addStyleClass("sapMLabelRequired");}l.setText(e.getSource().getTitle());l.setTooltip(e.getSource().getTitle());};h.prototype._getSupportedFilterItemList=function(){if(!this._supportedFilterItemList){this._supportedFilterItemList=[{type:"Bar",className:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroBar",iconLink:"sap-icon://horizontal-bar-chart",textKey:"VISUAL_FILTER_CHART_TYPE_BAR"},{type:"Donut",className:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroDonut",iconLink:"sap-icon://donut-chart",textKey:"VISUAL_FILTER_CHART_TYPE_Donut"},{type:"Line",className:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroLine",iconLink:"sap-icon://line-charts",textKey:"VISUAL_FILTER_CHART_TYPE_Line"}];}return this._supportedFilterItemList;};h.prototype._getSupportedFilterItemMap=function(){if(!this._supportedFilterItemMap){this._supportedFilterItemMap={};var e=this._getSupportedFilterItemList();for(var i=0;i<e.length;i++){var j=e[i];this._supportedFilterItemMap[j.type]=j;}}return this._supportedFilterItemMap;};h.prototype._resolveChartType=function(t){var e=this._getSupportedFilterItemMap();var i=e[t];if(!i){var j;for(j in e){i=e[j];break;}jQuery.sap.log.error("Could not resolve the filter component type: \""+t+"\", falling back to "+j);t=j;}return t;};h.prototype._createFilterItemOfType=function(t,p){var e=this._getSupportedFilterItemMap();var i=e[t];var j=i.className;jQuery.sap.require(j);var k=jQuery.sap.getObject(j);var l=new k(p);l.setSmartFilterId(this.getSmartFilterId());l.setModel(this.getModel('_filter'),'_filter');l.setModel(this.getModel('i18n'),'i18n');l.setModel(this.getModel("_templPriv"),"_templPriv");l.setModel(this.getModel('_visualFilterConfigModel'),"_visualFilterConfigModel");l.setModel(this.getModel());return l;};h.prototype.getConfig=function(I){var e=this.getModel('_visualFilterConfigModel').getData(),v={};if(!e){return{filterCompList:[]};}var j=0;var k=sap.ui.getCore().byFieldGroupId("headerBar");for(var i=0;i<e.filterCompList.length;i++){var l=e.filterCompList[i];if(I){v[l.component.properties.parentProperty]={shownInFilterBar:l.shownInFilterBar,component:{type:l.component.type,properties:{measureField:l.component.properties.measureField,sortOrder:l.component.properties.sortOrder,parentProperty:l.component.properties.parentProperty}}};}else{if(!l.shownInFilterBar){continue;}var m=k[j];if(!m){jQuery.sap.log.error("The configured selected filter bar items do not correspond to the actual filter bar items.  Could be an error during initialization, e.g. a chart class not found");return{filterCompList:[]};}j++;if(m._chart){var n=m;l.component.properties=n.getP13NConfig();}}}return I?v:e;};h.prototype.setSmartVariant=function(s){this.setAssociation("smartVariant",s);if(s){var p=new P({type:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.SmartVisualFilterBar",keyName:"persistencyKey"});p.setControl(this);}this._oVariantManagement=this._getVariantManagementControl(s);if(this._oVariantManagement){this._oVariantManagement.addPersonalizableControl(p);this._oVariantManagement.initialise(this._variantInitialised,this);this._oVariantManagement.attachSave(this._onVariantSave,this);}else if(s){if(typeof s==="string"){jQuery.sap.log.error("Variant with id="+s+" cannot be found");}else if(s instanceof sap.ui.core.Control){jQuery.sap.log.error("Variant with id="+s.getId()+" cannot be found");}}else{jQuery.sap.log.error("Missing SmartVariant");}};h.prototype._getVariantManagementControl=function(s){var e=null;if(s){e=typeof s=="string"?sap.ui.getCore().byId(s):s;if(e&&!(e instanceof S)){jQuery.sap.log.error("Control with the id="+s.getId?s.getId():s+" not of expected type");return null;}}return e;};h.prototype._variantInitialised=function(){if(!this._oCurrentVariant){this._oCurrentVariant="STANDARD";}};h.prototype._onVariantSave=function(){if(this._oCurrentVariant=="STANDARD"){this._oCurrentVariant={config:this.getConfig(true)};}};h.prototype.applyVariant=function(v,C){this._oCurrentVariant=v;if(this._oCurrentVariant=="STANDARD"){this._oCurrentVariant=null;}if(this._oCurrentVariant&&this._oCurrentVariant.config&&this._oCurrentVariant.config.filterCompList){this._oCurrentVariant.config=null;}if(this._oCurrentVariant&&this._oCurrentVariant.config==null){var e=this._getAnnotationSettings();if(e&&e.filterList){this._oCurrentVariant.config=this._convertSettingsToConfig(e,true);}}this._updateFilterBar();if(this._oVariantManagement){this._oVariantManagement.currentVariantSetModified(false);}};h.prototype._getVariantConfig=function(){return this._oCurrentVariant;};h.prototype.fetchVariant=function(){if(!this._oCurrentVariant||this._oCurrentVariant=="STANDARD"){var e=this._getAnnotationSettings();if(e&&e.filterList){this._oCurrentVariant={config:this._convertSettingsToConfig(e,true)};return this._oCurrentVariant;}else{return{config:null};}}return{config:this.getConfig(true)};};h.prototype.updateVisualFilterBindings=function(A){var e=sap.ui.getCore().byFieldGroupId("headerBar");for(var i=0;i<e.length;i++){if(e[i]._chart){e[i]._updateBinding();e[i]._bAllowBindingUpdateOnPropertyChange=A===true;}}};h.prototype.addVisualFiltersToBasicArea=function(p){var e=jQuery.extend(true,{},this.getModel('_visualFilterConfigModel').getData()),j=(p&&p.constructor===Array&&p.length)?p.length:0,C=0;if(!e){jQuery.sap.log.error("Could not add filter to basic area. No config found!");return false;}else if(!j){jQuery.sap.log.error("Improper parameter passed. Pass an array of properties.");return false;}else{for(var i=0;i<e.filterCompList.length;i++){var k=e.filterCompList[i];if(p.indexOf(d.readProperty(k.component.properties.parentProperty))!==-1&&!k.shownInFilterBar){k.shownInFilterBar=true;k.shownInFilterDialog=true;C++;}}if(C){this.getModel('_visualFilterConfigModel').setData(e);return true;}else{jQuery.sap.log.info("Filters already present in visual filter basic area");return false;}}};return h;},true);
