sap.ui.define(['jquery.sap.global','sap/ui/core/mvc/Controller','sap/ui/model/Filter','sap/ui/model/json/JSONModel',"sap/m/Button","sap/m/StandardListItem","sap/m/List","sap/m/ToolbarSpacer","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/ui/model/FilterOperator","sap/m/SearchField"],function(q,C,F,J,B,S,L,T,a,b,c){"use strict";var s=false,t={},I={},u="",D=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController",{});sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createDropdown=function(o,d,m,e,p){u=(p.filterRestriction=='multiple')?q.extend(true,{items:[],ranges:[],value:null},d.getDimensionFilter()):d.getDimensionFilter();var i=o.getModel('i18n'),f={"descriptionAndId":p.dimensionFieldDisplay,"descriptionOnly":p.dimensionFieldDisplay,"idAndDescription":p.dimensionField,"idOnly":p.dimensionField},f=(Object.keys(f).indexOf(p.textArrangement)!==-1)?f[p.textArrangement]:p.dimensionFieldDisplay,g=new sap.m.ToggleButton({icon:"sap-icon://menu",type:"Transparent",iconFirst:true,enabled:(u&&u.hasOwnProperty("items"))?Boolean(u.items.length):Boolean(u),tooltip:i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_SELECTED")}),l=sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createStandardListItem(m,d,i,e,p,g,f),h=sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createPopoverWithList(m,d,i,p,e,l,f,g),O=new sap.m.Button({text:i.getResourceBundle().getText("OK"),press:function(E){d.setDimensionFilter(u);d.fireFilterChange();h.close();}}),k=new sap.m.Button({text:i.getResourceBundle().getText("CANCEL"),press:function(){h.close();}});s=false;h.addContent(l);l.attachSelectionChange(function(E){var n=l.getModel().getData(E.mParameters.listItem.getBindingContext().sPath);n=n[p.dimensionField];var r=E.getParameters().listItem.mProperties.selected;if(p.filterRestriction==='multiple'){if(u.items&&u.items.length){for(var j=0;j<u.items.length;j++){if(u.items[j].key===n){u.items.splice(j,1);}else if(r){u.items.push({key:n});break;}}}else if(u.items){u.items.push({key:n});}else{u.items=[];}if(u.items.length){t.setVisible(true);I.setText(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[e,u.items.length]));}t.setVisible(Boolean(u.items.length));g.setEnabled(this.bUpdateToolbarButton||Boolean(u.items.length));}else if(p.filterRestriction==='single'){u=n;if(u){t.setVisible(true);I.setText(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[e,+Boolean(u)]));}g.setEnabled(Boolean(u));}}.bind(this));h.addStyleClass("sapSmartTemplatesAnalyticalListPageSelectedLinkDialog");h.setBeginButton(O);h.setEndButton(k);h.openBy(o);};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createPopoverWithList=function(m,o,i,p,d,l,f,e){var g=sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.isEntitytypeSearchable(m,p);if(this._oPopoverDialog){this._oPopoverDialog;}if(l){var A=function(E){if(E.getParameter("clearButtonPressed")){return;}var h=this.fnApplyFilterFromSearchField(f,E.getSource().getValue());var j=l.getBinding("items");s=false;e.setPressed(false);e.setTooltip(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_SELECTED"));j.filter(h);}.bind(this);this.oSearchField=new c({liveChange:A,search:A,enabled:g,initialFocus:true});this._oPopoverDialog=new sap.m.ResponsivePopover('',{placement:sap.m.PlacementType.Bottom,verticalScrolling:true,title:d,subHeader:[new sap.m.Toolbar({content:[this.oSearchField,e]})],content:[l]});this._oPopoverDialog.setModel(o.getModel("_filter"),"_filter");}return this._oPopoverDialog;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createStandardListItem=function(m,o,i,d,p,e,f){var g="/"+p.entitySet,h=sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.standardListItemTemplateCreation(o,p);I=new sap.m.Label({text:i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[d,typeof(o.getDimensionFilter())==="object"&&o.getDimensionFilter()!==null?o.getDimensionFilter().items.length:+Boolean(o.getDimensionFilter())])});t=new sap.m.Toolbar({content:[I,new sap.m.ToolbarSpacer(),new sap.ui.core.Icon({src:"sap-icon://sys-cancel",tooltip:i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_CLEAR_SELECTION"),press:function(E){t.setVisible(false);s=false;e.setTooltip(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_SELECTED"));e.setEnabled(false);e.setPressed(false);l.removeSelections(true);(u&&u.hasOwnProperty("items"))?u.items=[]:u="";I.setText(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[d,(u&&u.hasOwnProperty("items"))?u.items.length:+Boolean(u)]));l.getBinding("items").filter(this.fnApplyFilterFromSearchField(f,this.oSearchField.getValue()));}.bind(this)}).addStyleClass("sapSmartTemplatesAnalyticalListPageDropdownDialogCancelButton")],"visible":(u&&u.hasOwnProperty("items"))?Boolean(u.items.length):Boolean(u)});if(o.getSmartFilterId()){var j=sap.ui.getCore().byId(o.getSmartFilterId());if(j&&j.getEntitySet()===p.entitySet){g=o.considerAnalyticBinding(g,j);}}var k=[p.measureField,p.dimensionField,p.dimensionFieldDisplay],l=new sap.m.List({mode:p.filterRestriction==="single"?sap.m.ListMode.SingleSelectMaster:sap.m.ListMode.MultiSelect,growing:true,growingThreshold:15,showNoData:false,infoToolbar:t,items:{path:g,template:h,sorter:sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.getSortObject(p),parameters:{select:k.join(",")}}});h.setModel(o.getModel("_filter"),"_filter");l.setModel(m);e.attachPress(function(E){if(p.filterRestriction=="multiple"&&u.items.length||u&&u.hasOwnProperty('items')&&!u.items.length&&s){sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.updateFilterWithListBindings(l,e,i,p.filterRestriction,p.dimensionField);}else if(p.filterRestriction=="single"&&u!=null||u==null&&s){sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.updateFilterWithListBindings(l,e,i,p.filterRestriction,p.dimensionField);}});return l;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.selectedVisibilityUpdateFormatter=function(u,d){for(var i=0;i<u.items.length;i++){if(u.items[i].key===d){return true;}}return false;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.isEntitytypeSearchable=function(m,p){var o=m.getMetaModel().getODataEntitySet(p.entitySet);if(o.extensions.length){for(var i=0;i<o.extensions.length;i++){if(o.extensions[i].name=="searchable"){return o.extensions[i].value=="true";}}}return true;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.standardListItemTemplateCreation=function(o,p){var d=p.textArrangement,e=[];e.push({path:p.measureField});p.unitField?e.push({path:p.unitField}):"";var f=new sap.m.StandardListItem({title:{parts:[p.dimensionFieldDisplay,p.dimensionField],formatter:function(g,h){return a.getTextArrangement(g,h,d);}},description:{parts:e,formatter:function(g,h){return sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroChart.prototype._getFormattedNumberWithUoM(g,h);}},selected:{parts:["_filter>/"+o.getParentProperty(),p.dimensionField],formatter:function(g,h){if(s){return true;}else{if(typeof(u)==="object"&&u!==null){for(var i=0;i<u.items.length;i++){if(u.items[i].key===h){return true;}}}else{return(u!==null&&u===h)?true:false;}}}}});return f;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.getSortObject=function(p){if(p.sortOrder&&p.sortOrder.length){return new sap.ui.model.Sorter((p.sortOrder[0].Field)?p.sortOrder[0].Field.String:"",p.sortOrder[0].Descending.Boolean);}};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.updateFilterWithListBindings=function(l,o,d,f,e){var g=[];s=!s;this.bUpdateToolbarButton=s;if(s){o.setTooltip(d.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_ALL"));o.setEnabled(true);if(f==='multiple'){for(var i=0;i<u.items.length;i++){var h=new F(e,sap.ui.model.FilterOperator.EQ,(f==="multiple")?u.items[i].key:u);g.push(h);}}else if(f==='single'){var h=new F(e,sap.ui.model.FilterOperator.EQ,u);g.push(h);}l.getBinding("items").filter(g);}else{o.setTooltip(d.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_SELECTED"));o.setEnabled((u&&u.hasOwnProperty("items"))?Boolean(u.items.length):Boolean(u));l.getBinding("items").filter(g);}};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.fnApplyFilterFromSearchField=function(f,Q){var d=[];if(Q&&Q.length>0){var e=new F(f,b.Contains,Q);d.push(e);}return d;};return D;});
